================================================================
ЛАБОРАТОРНАЯ РАБОТА 2 — ТЕХНИЧЕСКОЕ ЗАДАНИЕ
================================================================

############################################################
# НАЗВАНИЕ
############################################################
Система управления персоналиями (Персона/Учитель/Ученик) с JSON-сериализацией,
DAO-слоем (файловое хранилище и кэширующая реализация), сервисом, и многопоточным
контроллером/диспетчером команд.

############################################################
# ОБЩЕЕ ОПИСАНИЕ
############################################################
Разработать прикладную библиотеку и консольное приложение, реализующие доменную
модель персоналий (абстрактная Персона, Учитель, Ученик), их сериализацию в JSON,
операции CRUD через DAO-слой на файловой системе и кэширующую DAO-реализацию в памяти.
Реализовать сервисный слой, а также два независимых потока:
(1) «контроллер» — периодически сканирует заданную папку на наличие файлов-команд и
перекладывает команды в очередь; (2) «диспетчер» — периодически читает очередь команд
и вызывает соответствующие методы сервисного слоя.

Результат поставляется в виде исполняемого JAR-файла с примером консольного запуска.

############################################################
# ТРЕБОВАНИЯ К ДОМЕННОЙ МОДЕЛИ
############################################################
1) Базовый тип: Person (Персона)
   • Person — НЕ должен иметь возможности непосредственного создания экземпляров.
     Требование: сделать класс абстрактным (abstract class). Допускается использование
     защищённого/приватного конструктора, если это усиливает инварианты.
   • Поля (минимально необходимые):
       - fullName : String  (ФИО)
       - birthYear : int    (год рождения)
       - phone : String     (номер телефона)
       - id : String        (уникальный идентификатор; генерируется при создании)
   • Инварианты:
       - Инициализация полей только через конструктор.
       - Поля доступны только для чтения через геттеры (без публичных сеттеров).
       - Идентификатор неизменяемый в течение всего жизненного цикла объекта.
   • Равенство и хеш-код:
       - equals()/hashCode() завязаны на неизменяемый id.

2) Наследники Person:
   • Teacher (Учитель)
       - subject : Subject (enum) — преподаваемый предмет.
       - workloadHours : int — рабочие часы/нагрузка (целое неотрицательное).
   • Student (Ученик)
       - studiedSubjects : List<Subject> — список изучаемых предметов (без дубликатов).
       - averageGrades : Map<Subject, Double> — средние оценки по предметам (0..10 включ.).

3) Перечисление предметов:
   • Subject : enum — конечный набор значений предметов (минимум 5–7 значений).
   • Требования к сериализации: корректное отображение enum в JSON-строковое значение.

############################################################
# СЕРИАЛИЗАЦИЯ И ДЕСЕРИАЛИЗАЦИЯ
############################################################
• Формат обмена: JSON.
• Библиотека: Jackson (ObjectMapper).
• Требования:
  - Сериализация и десериализация Teacher/Student (включая вложенные коллекции/Map).
  - Читабельный вывод (возможен pretty-print по флагу/настройке).
  - Поддержка полиморфной десериализации Person <- (Teacher|Student).
  - Валидация входных данных при десериализации (см. «Валидация и ошибки»).

############################################################
# DAO-ИНТЕРФЕЙС И РЕАЛИЗАЦИИ
############################################################
Общий интерфейс (примерно):
    interface PeopleDao {
        String create(Person p);                   // возвращает id созданного объекта
        Optional<Person> findById(String id);
        void update(Person p);                     // id должен уже существовать
        boolean delete(String id);
    }

1) FilePeopleDao — файловая реализация:
   • Конструктор принимает путь к рабочей папке (storageDir).
   • Формат хранения: один JSON-файл на объект (имя файла = <id>.json).
   • Семантика операций:
       - create: генерирует новый id (если у p.id пустой), записывает файл.
       - findById: читает файл, восстанавливает объект.
       - update: перезаписывает существующий файл того же id.
       - delete: удаляет соответствующий файл.
   • Требования к надёжности:
       - Атомарная запись (временный файл + rename).
       - Обработка повреждённых файлов (корректная ошибка).
       - Создание папки при необходимости.

2) CachedPeopleDao — кэширующая реализация:
   • Конструктор принимает «основной» DAO (например, FilePeopleDao) и инициализирует
     in-memory Map<String, Person> как write-through кэш.
   • Поведение:
       - create: кладёт в Map и делегирует create базовому DAO.
       - findById: сначала смотрит в Map, при промахе — делегирует и кэширует.
       - update/delete: синхронизирует Map с базовым DAO.
   • Интерфейс PeopleDao — идентичен FilePeopleDao (полиморфная прозрачность).

############################################################
# СЕРВИСНЫЙ СЛОЙ
############################################################
PeopleService — фасад над PeopleDao с бизнес-процедурами:
   • createTeacher(fullName, birthYear, phone, subject, workloadHours) : String (id)
   • createStudent(fullName, birthYear, phone, studiedSubjects, averageGrades) : String (id)
   • updateTeacher(id, mutableFields...) — изменить допустимые поля (см. Валидация).
   • updateStudent(id, mutableFields...) — изменить допустимые поля (см. Валидация).
   • getById(id) : Optional<Person>
   • deleteById(id) : boolean

############################################################
# ФАЙЛОВЫЕ КОМАНДЫ, КОНТРОЛЛЕР И ДИСПЕТЧЕР
############################################################
Формат файлов-команд: JSON (UTF-8). Каждый файл = одна команда.
Именование: cmd-<timestamp>-<random>.json. После успешной обработки файл удаляется.

Схема команды (пример):
{
  "op": "CreateStudent" | "CreateTeacher" | "UpdateStudent" | "UpdateTeacher" | "Delete" | "Get",
  "payload": { ... }            // аргументы операции
}

Примеры payload:
• CreateStudent:
  {
    "fullName": "Иванов Иван",
    "birthYear": 2002,
    "phone": "+7-999-000-00-00",
    "studiedSubjects": ["MATH", "PHYSICS"],
    "averageGrades": {"MATH": 8.7, "PHYSICS": 9.1}
  }
• UpdateTeacher:
  {
    "id": "<uuid>",
    "workloadHours": 750
  }
• Delete:
  { "id": "<uuid>" }

Компоненты и поведение:
1) Controller (контроллер):
   • Работает в отдельном потоке.
   • Каждую секунду сканирует указанную папку commandsDir.
   • Для каждого нового файла:
       - читает JSON, валидирует, преобразует в объект Command;
       - помещает команду в потокобезопасную очередь (BlockingQueue<Command>);
       - удаляет исходный файл.

2) Dispatcher (диспетчер):
   • Работает в отдельном потоке.
   • Каждую секунду опрашивает очередь; если не пуста — последовательно извлекает
     и выполняет через PeopleService.
   • Логирует результаты (успех/ошибка).

############################################################
# ПАКЕТЫ И СТРУКТУРА КОДА (РЕКОМЕНДАЦИЯ)
############################################################
com.example.people
  ├─ domain/         (Person, Teacher, Student, Subject)
  ├─ dao/            (PeopleDao, FilePeopleDao, CachedPeopleDao)
  ├─ service/        (PeopleService)
  ├─ control/        (Command, Controller, Dispatcher)
  ├─ app/            (ConsoleApp — точка входа, парсинг флагов)
  └─ util/           (JsonUtil, Validation, IdGenerator)

############################################################
# ВАЛИДАЦИЯ И ОШИБКИ
############################################################
• Общие правила:
  - fullName: непустая строка; нормализация пробелов.
  - birthYear: разумный диапазон (1900..текущий год).
  - phone: непусто; допускается простой шаблон валидации.
  - workloadHours: 0..10000.
  - studiedSubjects: без null и дубликатов.
  - averageGrades: ключи ⊆ studiedSubjects; значения в диапазоне 0..10.
• При нарушении инвариантов — IllegalArgumentException/ValidationException с
  понятным сообщением.
• Десериализация JSON: отдельные сообщения об ошибках полей.

############################################################
# ЛОГИРОВАНИЕ
############################################################
• Уровни: INFO (операции), WARN (подозрительные данные), ERROR (исключения).
• Свободный выбор фреймворка (java.util.logging/slf4j).

############################################################
# ПАРАМЕТРЫ ЗАПУСКА (КОНСОЛЬ)
############################################################
Обязательные/опциональные флаги приложения:
  -storage <path>       Папка для FilePeopleDao (по умолчанию ./storage).
  -commands <path>      Папка для входящих команд (по умолчанию ./commands).
  -cache on|off         Включать CachedPeopleDao поверх файлового (по умолчанию on).
  -pretty on|off        Форматировать JSON при выводе (по умолчанию off).
  -help                 Печать справки.

Пример запуска:
  java -jar people-system.jar -storage ./data -commands ./inbox -cache on

############################################################
# ТРЕБОВАНИЯ К ПОСТАВКЕ И СБОРКЕ
############################################################
• Итог: исполняемый JAR-файл.
• Без сборщиков (Maven/Gradle) — сборка средствами JDK.
• Внешние библиотеки: Jackson (добавление в classpath или через манифест JAR).
• Приложить README c примерами JSON-команд и сценариями запуска.
• Приложить тестовые данные (несколько JSON-файлов команд).

############################################################
# НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ
############################################################
• Потокобезопасность: очередь команд — потокобезопасная, DAO — согласованность
  между кэшем и файловой системой.
• Устойчивость к сбоям: атомарная запись, защитa от частично записанных файлов.
• Производительность: обработка минимум 100 команд в минуту последовательно.


############################################################
# МАТЕРИАЛЫ ДЛЯ ПРОЧТЕНИЯ
############################################################
• enum в Java — обзор и примеры:
  http://tutorials.jenkov.com/java/enums.html

• Jackson ObjectMapper — основы сериализации/десериализации:
  https://www.baeldung.com/jackson-object-mapper-tutorial

• DAO-паттерн — концепция и реализация в Java:
  https://www.baeldung.com/java-dao-pattern

• Очереди в Java (интерфейс Queue/BlockingQueue):
  https://www.baeldung.com/java-queue

• Потоки в Java — создание и запуск:
  http://tutorials.jenkov.com/java-concurrency/creating-and-starting-threads.html

================================================================
КОНЕЦ ТЕХНИЧЕСКОГО ЗАДАНИЯ
================================================================
